<!DOCTYPE html>
<html>
    <head>
        <title>keycloak HTML Demo</title>
        <script src="https://cdn.jsdelivr.net/npm/keycloak-js@latest/dist/keycloak.min.js"></script>
    </head>
    <body>
        <h1>Keycloak protected App</h1>
        <button onclick="keycloak.login()">login</button>
        <button onclick="keycloak.logout()">logout</button>
        <button onclick="showToken()">showToken</button>
        <button onclick="ValidateToken()">ValidateToken</button>
    <div id="output"></div>
    <script>
        const keycloak = new Keycloak({
            url: "http://localhost:8080/auth",
            realm: 'secure-app',
            clientId: "html-client"
        });

        keycloak.init({onLoad: "login-required", checkLoginIframe: true})
        .then(authenticated => {
            document.getElementById('output').innerHTML = authenticated ? "Authenticated<br>" : "Not Authenticated<br>";
        });

        setInterval(() => {
            keycloak.updateToken(30).catch(() => {
                alert("token expired or invalid logging out");
                keycloak.logout();
            });
        }, 10000);

        function showToken() {
            document.getElementById('output').innerHTML += "<p><b>AccessToken:</b><br>" + keycloak.token + "</p>";
        }

        async function ValidateToken() {
            try {
                const response = await fetch("http://localhost:8080/auth/realms/secure-app/protocol/openid-connect/userinfo", {
                    headers: {
                        "Authorization": "Bearer " + keycloak.token
                    }
                });
                if (!response.ok) throw new Error("Invalid token");
                const data = await response.json();
                document.getElementById("output").innerHTML += "<p>Token Valid. User: " + data.preferred_username + "</p>";

            } catch (err) {
                document.getElementById("output").innerHTML += "<p style='color:red'>" + err.message + "</p>";
            }
        }
    </script>
    </body>
</html>
